<script>
        // PASTIKAN URL INI SUDAH BENAR SESUAI DENGAN MILIK ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzDbrJRBUZQrxSbPnEA3VUcdXMTPLsFfP0S3oHZy6VGiLcQrvDyTcOeJqaFsXuOUzF/exec"; 
        
        const checkResultDiv = document.getElementById('checkResult');
        const regForm = document.getElementById('regForm');
        const formResultDiv = document.getElementById('formResult');
        const searchNameInput = document.getElementById('searchName');

        // Fungsi populateForm dan checkName tetap sama, tidak perlu diubah.
        function populateForm(dataToFill, isUpdate) {
            regForm.style.display = 'block';
            formResultDiv.innerHTML = '';
            if (isUpdate) {
                document.getElementById('formTitle').innerText = "Perbarui Biodata Anda";
                document.getElementById('submitBtn').innerText = "Update Data";
                document.getElementById('rowIndex').value = dataToFill.rowIndex;
                document.getElementById('KabupatenKota').value = dataToFill.data.KabupatenKota;
                document.getElementById('Nama').value = dataToFill.data.Nama;
                document.getElementById('TTL').value = dataToFill.data.TTL || dataToFill.data['Tempat, Tanggal Lahir']; // Handle both header names
                document.getElementById('Agama').value = dataToFill.data.Agama;
                document.getElementById('Jabatan').value = dataToFill.data.Jabatan;
                document.getElementById('PangkatGolongan').value = dataToFill.data.PangkatGolongan;
                document.getElementById('Grade').value = dataToFill.data.Grade;
            } else {
                document.getElementById('formTitle').innerText = "Formulir Pendaftaran Baru";
                document.getElementById('submitBtn').innerText = "Daftar Baru";
                regForm.reset();
                document.getElementById('Nama').value = searchNameInput.value; 
            }
        }

        async function checkName() {
            const nameToCheck = searchNameInput.value;
            if (nameToCheck.trim().length < 3) {
                checkResultDiv.innerHTML = `<p style="color: red;">Masukkan minimal 3 huruf.</p>`;
                return;
            }
            checkResultDiv.innerHTML = `<p>Mencari...</p>`;
            regForm.style.display = 'none';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&nama=${encodeURIComponent(nameToCheck)}`);
                const result = await response.json();
                if (result.result === 'found_multiple') {
                    checkResultDiv.innerHTML = `<h4>Ditemukan beberapa nama yang cocok. Apakah ini Anda?</h4><div class="name-selection"></div>`;
                    const selectionDiv = checkResultDiv.querySelector('.name-selection');
                    result.data.forEach(match => {
                        const option = document.createElement('div');
                        option.className = 'name-option';
                        option.textContent = `${match.data.Nama} (${match.data.KabupatenKota})`;
                        option.onclick = () => {
                            checkResultDiv.innerHTML = `<p style="color: green;">Data untuk <b>${match.data.Nama}</b> dipilih. Silakan perbarui di bawah.</p>`;
                            populateForm(match, true);
                        };
                        selectionDiv.appendChild(option);
                    });
                    const notMeOption = document.createElement('div');
                    notMeOption.className = 'name-option';
                    notMeOption.innerHTML = `<b>Bukan nama di atas? Daftar sebagai peserta baru.</b>`;
                    notMeOption.onclick = () => {
                        checkResultDiv.innerHTML = '';
                        populateForm(null, false);
                    };
                    selectionDiv.appendChild(notMeOption);
                } else if (result.result === 'not_found') {
                    checkResultDiv.innerHTML = `<p style="color: blue;">Nama tidak ditemukan. Silakan isi formulir pendaftaran baru di bawah.</p>`;
                    populateForm(null, false);
                } else {
                    checkResultDiv.innerHTML = `<p style="color: red;">Terjadi Kesalahan: ${result.message}</p>`;
                }
            } catch (error) {
                checkResultDiv.innerHTML = `<p style="color: red;">Gagal menghubungi server. Pastikan URL Web App sudah benar dan di-deploy ulang.</p>`;
            }
        }

        // ====================================================================
        // BAGIAN YANG DIPERBAIKI ADA DI SINI
        // ====================================================================
        regForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "Menyimpan...";
            
            const formData = new FormData(regForm);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });
            
            fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', // <-- INI ADALAH PERBAIKANNYA
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                redirect: 'follow'
            })
            .then(() => {
                // Karena mode 'no-cors', kita tidak bisa membaca balasan dari skrip.
                // Jadi kita langsung tampilkan pesan sukses generik di sini.
                formResultDiv.innerHTML = `<p style="color: green;">Pendaftaran atau Update Anda sedang diproses. Silakan periksa hasilnya di Google Sheet.</p>`;
                submitBtn.disabled = false;
                submitBtn.innerText = "Kirim Lagi";
                regForm.reset();
                regForm.style.display = 'none';
            })
            .catch(error => {
                // Blok catch ini kemungkinan tidak akan berjalan dengan mode no-cors, tapi ini adalah praktik yang baik.
                formResultDiv.innerHTML = `<p style="color: red;">Terjadi kesalahan yang tidak terduga saat mengirim data.</p>`;
                submitBtn.disabled = false;
            });
        });
    </script>
