<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran & Update Data Peserta</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .name-selection { margin-top: 1rem; }
        .name-option {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .name-option:hover { background-color: #f0f0f0; }
    </style>
</head>
<body>

    <header>
        <h1><a href="index.html">ðŸŽ„ Acara Natal 2025 ðŸŽ„</a></h1>
    </header>

    <main class="container">
        <div class="form-container">
            <div id="checkNameSection">
                <h2>Pendaftaran & Update Data</h2>
                <p>Masukkan nama Anda (bisa nama depan/belakang) untuk mencari data.</p>
                <input type="text" id="searchName" placeholder="Ketik Nama Anda di Sini" required>
                <button onclick="checkName()">Cari Nama Saya</button>
            </div>

            <div id="checkResult"></div>

            <form id="regForm" style="display:none;">
                <h3 id="formTitle">Formulir Biodata</h3>
                <input type="hidden" id="rowIndex" name="rowIndex">
                
                <label for="KabupatenKota">Kabupaten / Kota</label>
                <input type="text" id="KabupatenKota" name="KabupatenKota" required>
                
                <label for="Nama">Nama Lengkap</label>
                <input type="text" id="Nama" name="Nama" required>
                
                <label for="TTL">Tempat, Tanggal Lahir</label>
                <input type="text" id="TTL" name="TTL" placeholder="Contoh: Jakarta, 25 Desember 1990" required>
                
                <label for="Agama">Agama</label>
                <input type="text" id="Agama" name="Agama" required>
                
                <label for="Jabatan">Jabatan</label>
                <input type="text" id="Jabatan" name="Jabatan" required>
                
                <label for="PangkatGolongan">Pangkat/Golongan</label>
                <input type="text" id="PangkatGolongan" name="PangkatGolongan">
                
                <label for="Grade">Grade</label>
                <input type="text" id="Grade" name="Grade">

                <button type="submit" id="submitBtn">Daftar</button>
            </form>
            <div id="formResult"></div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 Panitia Natal.</p>
    </footer>

    <script>
        // PENTING: Ganti dengan URL Web App Anda yang sudah di-deploy ulang
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzDbrJRBUZQrxSbPnEA3VUcdXMTPLsFfP0S3oHZy6VGiLcQrvDyTcOeJqaFsXuOUzF/exec"; 
        
        const checkResultDiv = document.getElementById('checkResult');
        const regForm = document.getElementById('regForm');
        const formResultDiv = document.getElementById('formResult');
        const searchNameInput = document.getElementById('searchName');

        function populateForm(dataToFill, isUpdate) {
            regForm.style.display = 'block';
            formResultDiv.innerHTML = '';
            if (isUpdate) {
                document.getElementById('formTitle').innerText = "Perbarui Biodata Anda";
                document.getElementById('submitBtn').innerText = "Update Data";
                document.getElementById('rowIndex').value = dataToFill.rowIndex;
                document.getElementById('KabupatenKota').value = dataToFill.data.KabupatenKota;
                document.getElementById('Nama').value = dataToFill.data.Nama;
                document.getElementById('TTL').value = dataToFill.data.TTL || dataToFill.data['Tempat, Tanggal Lahir'];
                document.getElementById('Agama').value = dataToFill.data.Agama;
                document.getElementById('Jabatan').value = dataToFill.data.Jabatan;
                document.getElementById('PangkatGolongan').value = dataToFill.data.PangkatGolongan;
                document.getElementById('Grade').value = dataToFill.data.Grade;
            } else {
                document.getElementById('formTitle').innerText = "Formulir Pendaftaran Baru";
                document.getElementById('submitBtn').innerText = "Daftar Baru";
                regForm.reset();
                document.getElementById('Nama').value = searchNameInput.value;
            }
        }

        async function checkName() {
            const nameToCheck = searchNameInput.value;
            if (nameToCheck.trim().length < 3) {
                checkResultDiv.innerHTML = `<p style="color: red;">Masukkan minimal 3 huruf.</p>`;
                return;
            }
            checkResultDiv.innerHTML = `<p>Mencari...</p>`;
            regForm.style.display = 'none';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&nama=${encodeURIComponent(nameToCheck)}`);
                const result = await response.json();
                if (result.result === 'found_multiple') {
                    checkResultDiv.innerHTML = `<h4>Ditemukan beberapa nama yang cocok. Apakah ini Anda?</h4><div class="name-selection"></div>`;
                    const selectionDiv = checkResultDiv.querySelector('.name-selection');
                    result.data.forEach(match => {
                        const option = document.createElement('div');
                        option.className = 'name-option';
                        option.textContent = `${match.data.Nama} (${match.data.KabupatenKota})`;
                        option.onclick = () => {
                            checkResultDiv.innerHTML = `<p style="color: green;">Data untuk <b>${match.data.Nama}</b> dipilih. Silakan perbarui di bawah.</p>`;
                            populateForm(match, true);
                        };
                        selectionDiv.appendChild(option);
                    });
                    const notMeOption = document.createElement('div');
                    notMeOption.className = 'name-option';
                    notMeOption.innerHTML = `<b>Bukan nama di atas? Daftar sebagai peserta baru.</b>`;
                    notMeOption.onclick = () => {
                        checkResultDiv.innerHTML = '';
                        populateForm(null, false);
                    };
                    selectionDiv.appendChild(notMeOption);
                } else if (result.result === 'not_found') {
                    checkResultDiv.innerHTML = `<p style="color: blue;">Nama tidak ditemukan. Silakan isi formulir pendaftaran baru di bawah.</p>`;
                    populateForm(null, false);
                } else {
                    checkResultDiv.innerHTML = `<p style="color: red;">Terjadi Kesalahan dari Server: ${result.message}</p>`;
                }
            } catch (error) {
                checkResultDiv.innerHTML = `<p style="color: red;">Gagal menghubungi server. Pastikan URL Web App sudah benar dan di-deploy ulang.</p>`;
            }
        }

        regForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "Menyimpan...";
            
            const formData = new FormData(regForm);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });
            
            fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                redirect: 'follow'
            })
            .then(() => {
                formResultDiv.innerHTML = `<p style="color: green;">Pendaftaran atau Update Anda sedang diproses. Silakan periksa hasilnya langsung di Google Sheet.</p>`;
                submitBtn.disabled = false;
                submitBtn.innerText = "Kirim Lagi";
                regForm.reset();
                regForm.style.display = 'none';
            })
            .catch(error => {
                formResultDiv.innerHTML = `<p style="color: red;">Terjadi kesalahan yang tidak terduga saat mengirim data.</p>`;
                submitBtn.disabled = false;
            });
        });
    </script>
</body>
</html>
